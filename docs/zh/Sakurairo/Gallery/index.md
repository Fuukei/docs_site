---
title: 内建随机图API使用说明
---

# 内建随机图 <Badge type="tip" text="v3.0" />

主题内建随机图API，与主题设置自然集成，支持在线WebP图片体积优化

## 功能说明  

首次使用请前往后台 `iro主题设置 > 主页设置 > 封面设置 > 内建API控制器`  
并点击初始化进行初始化  

初始化后会在你网站的`wp-contents/uploads`下生成`iro_gallery`文件夹作为工作目录  
目录解释说明：
```
.
├── iro_gallery       // 工作目录
│   ├── img           // 存放供访问的图片
│   ├── backup        // 用于备份原图的文件夹
|   ├── imglist.json  // 图片索引
```

API使用文件索引代替每次都遍历目录进行性能优化，  
所以每次改变img内容后都需要重建索引，否则可能会返回无效图片链接。

backup目录为图片WebP优化原图备份目录，  
由于与超时断点恢复设置可能冲突，所以使用相关功能前请确保目录为空。  

## 使用方法：

### 随机图片

在`iro_gallery`下的`img`文件夹中存放你喜欢的图片，可以使用文件夹进行分类整理  
摆放完毕后返回后台点击重建索引即可  
然后切换封面随机图片选项为内建API就可以开始使用啦

> [!TIP]
> API使用文件索引进行性能优化，  
> 所以每次更改内容后都需要重建索引！  

> [!TIP]
> 内建API与主题CDN设置集成，具体参考`图片CDN`设置项，  
> 正确配置后相关图片即可从你的CDN链接加载。

### WebP优化  
WebP是专为网络传输设计的文件格式，可以在尽量保证图片质量的前提下极大地减小文件的体积  
但部分旧版浏览器可能支持不佳

使用前请确保img文件夹内容可以被PHP写入，  
如果你使用的是管理员身份上传图片，请更改文件权限为可写（与程序创建的iro_gallery文件夹一致）

做好以上工作后，直接点击后台的`WebP优化`即可。  
转换完毕后记得`重建索引`！

> [!TIP]
> 转换过程页面持续加载、白屏、黑屏为正常现象，  
> 如果你没有更改过PHP的默认默认设置[max_execution_time]  
> 一般最长等待30~60秒即可（具体取决于你的文件数量以及你的服务器性能）  
> 使用FFmpeg等工具本地转换好后上传使用效果是相同的

> [!TIP]
> 页面显示后，请检查你的文件是否已全部转换完成。  
> 如果没有（受限于你服务器性能、PHP的允许时长配置），你可以尝试刷新页面以继续转换，直至全部转换完成。  
> API的断点恢复设计为直至backup目录内每个图片在img文件夹内均有对应WebP格式版本。  
> 你也可以自行本地使用工具转换后上传至img文件夹后点击重建索引。

> [!TIP]
> 内建API会自动分拣图片，以9/10宽高为标准，暂无设置支持关闭或更改标准  
> 返回图片逻辑如下：  
> 移动端优先返回长图片，PC端优先返回宽图片  
> 当某一分类下没有符合要求的图片时，才会从另一分类返回图片